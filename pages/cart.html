<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Shopping Cart | MealMint</title>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700;800&display=swap"
        rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/sweetalert2@11/dist/sweetalert2.min.css" rel="stylesheet">
    <link rel="stylesheet" href="../assets/css/global.css">
    <link rel="stylesheet" href="../assets/css/customer.css">
</head>

<body>
    <div id="loader-wrapper">
        <div class="loader"></div>
    </div>

    <!-- Navbar -->
    <nav class="navbar navbar-expand-lg navbar-light customer-navbar sticky-top">
        <div class="container">
            <a class="navbar-brand" href="home.html">MEALMINT</a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav ms-auto align-items-center">
                    <li class="nav-item"><a class="nav-link" href="home.html">Home</a></li>
                    <li class="nav-item"><a class="nav-link" href="orders.html">My Orders</a></li>
                    <li class="nav-item position-relative">
                        <a class="nav-link active" href="cart.html">
                            <i class="fas fa-shopping-cart"></i> Cart
                            <span id="cart-badge"
                                class="badge bg-danger rounded-pill position-absolute top-0 start-100 translate-middle"
                                style="display: none;">0</span>
                        </a>
                    </li>
                    <li class="nav-item"><a class="nav-link" href="profile.html">Profile</a></li>
                    <li class="nav-item"><a class="nav-link text-danger" href="#" onclick="logout()">Logout</a></li>
                </ul>
            </div>
        </div>
    </nav>

    <!-- Cart Content -->
    <div class="container my-5">
        <h2 class="fw-bold mb-4">Your Cart</h2>

        <div class="row">
            <div class="col-lg-8">
                <div class="card">
                    <div class="card-body" id="cart-items">
                        <!-- Cart items will be loaded here -->
                    </div>
                </div>
            </div>

            <div class="col-lg-4">
                <div class="card sticky-top" style="top: 100px;">
                    <div class="card-body">
                        <h5 class="fw-bold mb-4">Order Summary</h5>
                        <div class="d-flex justify-content-between mb-2">
                            <span>Subtotal:</span>
                            <span id="subtotal">Rs 0</span>
                        </div>
                        <div class="d-flex justify-content-between mb-2">
                            <span>Delivery Fee:</span>
                            <span>Rs 50</span>
                        </div>
                        <hr>
                        <div class="d-flex justify-content-between mb-4">
                            <strong>Total:</strong>
                            <strong id="total" class="text-primary-color">Rs 50</strong>
                        </div>
                        <button class="btn btn-primary w-100 py-3" id="place-order-btn" onclick="placeOrder()">Proceed
                            to Checkout</button>
                    </div>
                </div>
            </div>
        </div>

        <div id="empty-cart" class="empty-state" style="display: none;">
            <img src="https://cdn-icons-png.flaticon.com/512/2762/2762885.png" alt="Empty cart">
            <h3>Your cart is empty</h3>
            <p class="text-muted">Add some delicious items to get started!</p>
            <a href="home.html" class="btn btn-primary mt-3">Browse Restaurants</a>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script type="module" src="../assets/js/auth.js"></script>
    <script type="module" src="../assets/js/role-guard.js"></script>
    <script src="../assets/js/cart.js"></script>
    <script type="module">
        import { db, auth } from '../assets/js/firebase-config.js';
        import { collection, addDoc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        checkAuth('user').then(() => {
            renderCart();
            updateCartBadge();
            hideLoader();
        }).catch(() => {
            hideLoader();
        });

        function renderCart() {
            const cart = getCart();
            const container = document.getElementById('cart-items');
            const emptyState = document.getElementById('empty-cart');

            if (cart.length === 0) {
                emptyState.style.display = 'block';
                document.querySelector('.row').style.display = 'none';
                return;
            }

            container.innerHTML = cart.map(item => `
                <div class="cart-item">
                    <img src="${item.imageUrl || 'https://via.placeholder.com/80'}" class="cart-item-image" alt="${item.name}" onerror="this.src='https://via.placeholder.com/80'">
                    <div class="flex-grow-1">
                        <h6 class="mb-1">${item.name}</h6>
                        <p class="text-muted small mb-2">${item.shopName}</p>
                        <strong class="text-primary-color">Rs ${item.price}</strong>
                    </div>
                    <div class="quantity-controls">
                        <button class="quantity-btn" onclick="changeQuantity('${item.id}', -1)" ${item.quantity <= 1 ? 'disabled' : ''}>-</button>
                        <span class="fw-bold">${item.quantity}</span>
                        <button class="quantity-btn" onclick="changeQuantity('${item.id}', 1)">+</button>
                    </div>
                    <button class="btn btn-sm btn-outline-danger ms-3" onclick="removeItem('${item.id}')">Remove</button>
                </div>
            `).join('');

            updateSummary();
        }

        function updateSummary() {
            const subtotal = getCartTotal();
            const deliveryFee = 50;
            const total = subtotal + deliveryFee;

            document.getElementById('subtotal').textContent = `Rs ${subtotal}`;
            document.getElementById('total').textContent = `Rs ${total}`;
        }

        window.changeQuantity = function (itemId, change) {
            updateQuantity(itemId, change);
            renderCart();
            updateCartBadge();
        };

        window.removeItem = function (itemId) {
            Swal.fire({
                title: 'Remove item?',
                text: 'Are you sure you want to remove this item from cart?',
                icon: 'warning',
                showCancelButton: true,
                confirmButtonColor: '#d70f64',
                cancelButtonColor: '#6c757d',
                confirmButtonText: 'Yes, remove it'
            }).then((result) => {
                if (result.isConfirmed) {
                    removeFromCart(itemId);
                    renderCart();
                    updateCartBadge();
                    showToast('Item removed from cart', 'success');
                }
            });
        };

        window.placeOrder = function () {
            const cart = getCart();

            if (cart.length === 0) {
                Swal.fire('Error', 'Your cart is empty', 'error');
                return;
            }

            // Check if all items are from the same shop
            const shopIds = [...new Set(cart.map(item => item.shopId))];
            if (shopIds.length > 1) {
                Swal.fire('Error', 'You can only order from one restaurant at a time', 'error');
                return;
            }

            // Redirect to Checkout Page
            window.location.href = 'checkout.html';
        };
    </script>
</body>

</html>